<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>学习观测 MySQL - 猎户座</title><meta name=Description content><meta property="og:title" content="学习观测 MySQL"><meta property="og:description" content="查看连接 show processlist showprocesslist;+----+------+-----------+--------------------+---------+------+----------+------------------+ |Id|User|Host|db|Command|Time|State|Info|+----+------+-----------+--------------------+---------+------+----------+------------------+ |11|root|localhost|information_schema|Sleep|9886||NULL||16|root|localhost|information_schema|Sleep|7874||NULL||18|root|localhost|test|Query|0|starting|showprocesslist|+----+------+-----------+--------------------+---------+------+----------+------------------+ 3rowsinset(0.00sec)每个字段含义参考官方文档，具体 state 值的具体含义参考 https://dev.mysql."><meta property="og:type" content="article"><meta property="og:url" content="https://catplanet007.github.io/blog/posts/database/mysql-observability/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-02T19:54:07+08:00"><meta property="article:modified_time" content="2021-01-02T19:54:07+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="学习观测 MySQL"><meta name=twitter:description content="查看连接 show processlist showprocesslist;+----+------+-----------+--------------------+---------+------+----------+------------------+ |Id|User|Host|db|Command|Time|State|Info|+----+------+-----------+--------------------+---------+------+----------+------------------+ |11|root|localhost|information_schema|Sleep|9886||NULL||16|root|localhost|information_schema|Sleep|7874||NULL||18|root|localhost|test|Query|0|starting|showprocesslist|+----+------+-----------+--------------------+---------+------+----------+------------------+ 3rowsinset(0.00sec)每个字段含义参考官方文档，具体 state 值的具体含义参考 https://dev.mysql."><meta name=application-name content="猎户座"><meta name=apple-mobile-web-app-title content="猎户座"><link rel="shortcut icon" type=image/x-icon href=/blog/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/blog/apple-touch-icon.png><link rel=manifest href=/blog/site.webmanifest><link rel=canonical href=https://catplanet007.github.io/blog/posts/database/mysql-observability/><link rel=prev href=https://catplanet007.github.io/blog/posts/database/learning-redis/><link rel=next href=https://catplanet007.github.io/blog/posts/trouble-shooting/grpc-debug/><link rel=stylesheet href=/blog/lib/normalize/normalize.min.css><link rel=stylesheet href=/blog/css/style.min.css><link rel=stylesheet href=/blog/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/blog/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"学习观测 MySQL","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/catplanet007.github.io\/blog\/posts\/database\/mysql-observability\/"},"genre":"posts","keywords":"MySQL, TroubleShooting","wordcount":4229,"url":"https:\/\/catplanet007.github.io\/blog\/posts\/database\/mysql-observability\/","datePublished":"2021-01-02T19:54:07+08:00","dateModified":"2021-01-02T19:54:07+08:00","publisher":{"@type":"Organization","name":"catplanet"},"author":{"@type":"Person","name":"catplanet"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/blog/ title=猎户座>猎户座</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/posts/>文章 </a><a class=menu-item href=/blog/tags/>标签 </a><a class=menu-item href=/blog/categories/>分类 </a><a class=menu-item href=/blog/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/blog/ title=猎户座>猎户座</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/blog/posts/ title>文章</a><a class=menu-item href=/blog/tags/ title>标签</a><a class=menu-item href=/blog/categories/ title>分类</a><a class=menu-item href=/blog/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">学习观测 MySQL</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=about/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>catplanet</a></span>&nbsp;<span class=post-category>收录于 <a href=/blog/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-01-02>2021-01-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4229 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 9 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#查看连接>查看连接</a><ul><li><a href=#show-processlist>show processlist</a></li><li><a href=#innodb_thread_concurrency>innodb_thread_concurrency</a></li><li><a href=#长事务>长事务</a><ul><li><a href=#innodb_trx>innodb_trx</a></li><li><a href=#pt-kill>pt-kill</a></li></ul></li><li><a href=#查询表锁>查询表锁</a></li><li><a href=#查询行锁>查询行锁</a></li></ul></li><li><a href=#日志>日志</a><ul><li><a href=#general_log>general_log</a></li><li><a href=#slow_log>slow_log</a></li><li><a href=#查看-binlog>查看 binlog</a></li><li><a href=#回滚数据>回滚数据</a></li><li><a href=#监控-binlogredo-log-io-耗时>监控 binlog/redo log IO 耗时</a></li><li><a href=#查看主备延迟>查看主备延迟</a></li><li><a href=#mysqldump>mysqldump</a></li><li><a href=#sql_safe_updates>sql_safe_updates</a></li></ul></li><li><a href=#innodb-状态>innodb 状态</a><ul><li><a href=#buffer-pool-hit-rate>Buffer pool hit rate</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=查看连接>查看连接</h2><h3 id=show-processlist>show processlist</h3><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>processlist</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>----+------+-----------+--------------------+---------+------+----------+------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>Id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>User</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Host</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>db</span><span class=w>                 </span><span class=o>|</span><span class=w> </span><span class=n>Command</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Time</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>State</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>Info</span><span class=w>             </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>----+------+-----------+--------------------+---------+------+----------+------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=mi>11</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>information_schema</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Sleep</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=mi>9886</span><span class=w> </span><span class=o>|</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>             </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>information_schema</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Sleep</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=mi>7874</span><span class=w> </span><span class=o>|</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>             </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=mi>18</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w>               </span><span class=o>|</span><span class=w> </span><span class=n>Query</span><span class=w>   </span><span class=o>|</span><span class=w>    </span><span class=mi>0</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>starting</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=n>processlist</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>----+------+-----------+--------------------+---------+------+----------+------------------+
</span><span class=c1></span><span class=mi>3</span><span class=w> </span><span class=k>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>每个字段含义参考<a href=https://dev.mysql.com/doc/refman/8.0/en/show-processlist.html target=_blank rel="noopener noreffer">官方文档</a>，具体 state 值的具体含义参考 <a href=https://dev.mysql.com/doc/refman/5.6/en/general-thread-states.html>https://dev.mysql.com/doc/refman/5.6/en/general-thread-states.html</a>。</p><h3 id=innodb_thread_concurrency>innodb_thread_concurrency</h3><p><code>innodb_thread_concurrency</code> 表示 InnoDB 的并发执行的线程上限，达到这个值后，InnoDB 会阻塞新的线程执行，通常将 innodb_thread_concurrency 设置为 64-128 之间的值，因为 CPU 核数有限，防止过多线程频繁地上下文切换。</p><p>注意并发连接和并发线程不同，被同一个锁阻塞的所有线程并发计数为1、sleep 状态的线程不计入并发线程，因为这些线程不占用 CPU。</p><h3 id=长事务>长事务</h3><p>长事务提交之前，它的所有回滚记录都必须保留，会占用大量存储空间。</p><p>同时长事务会一直占用 MDL（metadata lock)。CRUD 和 DDL 都会请求 MDL，如果有长事务长期占用 DML 读锁，如果这时有 DDL 会因为拿不到 DML 的写锁而被阻塞，然后再阻塞这个表的所有 CRUD。</p><p>MySQL 5.6 Online DDL 的过程：</p><ol><li>拿 MDL 写锁</li><li>降级成 MDL 读锁</li><li>真正做 DDL</li><li>升级成 MDL 写锁</li><li>释放 MDL 锁</li></ol><p>1、2、4、5 如果没有锁冲突，执行时间非常短。第 3 步占用了 DDL 绝大部分时间，这期间这个表可以正常读写数据，是因此称为“online”。</p><h4 id=innodb_trx>innodb_trx</h4><p>当前事务在 <code>information_schema.innodb_trx</code> 中。</p><p>查看长事务：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=n>innodb_trx</span><span class=w> 
</span><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>TIME_TO_SEC</span><span class=p>(</span><span class=n>timediff</span><span class=p>(</span><span class=n>now</span><span class=p>(),</span><span class=n>trx_started</span><span class=p>))</span><span class=o>&gt;</span><span class=mi>60</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>监控 <code>information_schema.innodb_trx</code> 表，设置长事务阈值，超过就报警 / 或者 kill。</p><h4 id=pt-kill>pt-kill</h4><p>也可以使用 <a href=https://www.percona.com/downloads/percona-toolkit/LATEST target=_blank rel="noopener noreffer">Percona Toolkit</a> 的 pt-kill 这个工具。</p><h3 id=查询表锁>查询表锁</h3><p>使用 performance_schema 和 sys 系统库。MySQL 启动时需要设置 performance_schema=on，相比于设置为 off 会有 10% 左右的性能损失。</p><p>例如：
session 1 持有 MDL 写锁：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>lock</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>aa</span><span class=w> </span><span class=k>write</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>session 2 查询被阻塞：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>aa</span><span class=p>;</span><span class=w>
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>processlist</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>----+------+-----------+------+---------+------+---------------------------------+------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>Id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>User</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>Host</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>db</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>Command</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Time</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>State</span><span class=w>                           </span><span class=o>|</span><span class=w> </span><span class=n>Info</span><span class=w>             </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>----+------+-----------+------+---------+------+---------------------------------+------------------+
</span><span class=c1></span><span class=o>|</span><span class=w>  </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>sys</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>Query</span><span class=w>   </span><span class=o>|</span><span class=w>    </span><span class=mi>0</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>starting</span><span class=w>                        </span><span class=o>|</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=n>processlist</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w>  </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Sleep</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=mi>27</span><span class=w> </span><span class=o>|</span><span class=w>                                 </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>             </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w>  </span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Query</span><span class=w>   </span><span class=o>|</span><span class=w>    </span><span class=mi>9</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>metadata</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>aa</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>----+------+-----------+------+---------+------+---------------------------------+------------------+
</span></code></pre></div><p>使用<code>show processlist</code>虽然可以看到 query 被 MDL 阻塞，但无法看出是被哪个连接阻塞的，这时需要查看 <code>sys.schema_table_lock_waits</code>表：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>schema_table_lock_waits</span><span class=err>\</span><span class=k>G</span><span class=w>
</span><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span><span class=w>               </span><span class=n>object_schema</span><span class=p>:</span><span class=w> </span><span class=n>test</span><span class=w>
</span><span class=w>                 </span><span class=n>object_name</span><span class=p>:</span><span class=w> </span><span class=n>aa</span><span class=w>
</span><span class=w>           </span><span class=n>waiting_thread_id</span><span class=p>:</span><span class=w> </span><span class=mi>35</span><span class=w>
</span><span class=w>                 </span><span class=n>waiting_pid</span><span class=p>:</span><span class=w> </span><span class=mi>10</span><span class=w>
</span><span class=w>             </span><span class=n>waiting_account</span><span class=p>:</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=n>localhost</span><span class=w>
</span><span class=w>           </span><span class=n>waiting_lock_type</span><span class=p>:</span><span class=w> </span><span class=n>SHARED_READ</span><span class=w>
</span><span class=w>       </span><span class=n>waiting_lock_duration</span><span class=p>:</span><span class=w> </span><span class=k>TRANSACTION</span><span class=w>
</span><span class=w>               </span><span class=n>waiting_query</span><span class=p>:</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>aa</span><span class=w>
</span><span class=w>          </span><span class=n>waiting_query_secs</span><span class=p>:</span><span class=w> </span><span class=mi>69</span><span class=w>
</span><span class=w> </span><span class=n>waiting_query_rows_affected</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w> </span><span class=n>waiting_query_rows_examined</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>          </span><span class=n>blocking_thread_id</span><span class=p>:</span><span class=w> </span><span class=mi>36</span><span class=w>
</span><span class=w>                </span><span class=n>blocking_pid</span><span class=p>:</span><span class=w> </span><span class=mi>11</span><span class=w>
</span><span class=w>            </span><span class=n>blocking_account</span><span class=p>:</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=n>localhost</span><span class=w>
</span><span class=w>          </span><span class=n>blocking_lock_type</span><span class=p>:</span><span class=w> </span><span class=n>SHARED_NO_READ_WRITE</span><span class=w>
</span><span class=w>      </span><span class=n>blocking_lock_duration</span><span class=p>:</span><span class=w> </span><span class=k>TRANSACTION</span><span class=w>
</span><span class=w>     </span><span class=n>sql_kill_blocking_query</span><span class=p>:</span><span class=w> </span><span class=n>KILL</span><span class=w> </span><span class=n>QUERY</span><span class=w> </span><span class=n>innodb_thread_concurrency11</span><span class=w>
</span><span class=w></span><span class=n>sql_kill_blocking_connection</span><span class=p>:</span><span class=w> </span><span class=n>KILL</span><span class=w> </span><span class=mi>11</span><span class=w>
</span><span class=w></span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></code></pre></div><p>注意如果查不到值，需要设置，具体可以参考 <a href=https://dev.mysql.com/doc/refman/8.0/en/performance-schema-metadata-locks-table.html>https://dev.mysql.com/doc/refman/8.0/en/performance-schema-metadata-locks-table.html</a></p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>UPDATE</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>setup_instruments</span><span class=w>
</span><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>ENABLED</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;YES&#39;</span><span class=p>,</span><span class=w> </span><span class=n>TIMED</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;YES&#39;</span><span class=w>
</span><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;wait/lock/metadata/sql/mdl&#39;</span><span class=p>;</span><span class=w>
</span></code></pre></div><h3 id=查询行锁>查询行锁</h3><p>session 1：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>begin</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>update</span><span class=w> </span><span class=n>aa</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>89998</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>session 2：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>aa</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>share</span><span class=w> </span><span class=k>mode</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>这时要查询 <code>sys.innodb_lock_waits</code> 找到占用锁的线程。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>innodb_lock_waits</span><span class=err>\</span><span class=k>G</span><span class=w>
</span><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span><span class=w>                </span><span class=n>wait_started</span><span class=p>:</span><span class=w> </span><span class=mi>2020</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>23</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>40</span><span class=p>:</span><span class=mi>31</span><span class=w>
</span><span class=w>                    </span><span class=n>wait_age</span><span class=p>:</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>50</span><span class=w>
</span><span class=w>               </span><span class=n>wait_age_secs</span><span class=p>:</span><span class=w> </span><span class=mi>50</span><span class=w>
</span><span class=w>                </span><span class=n>locked_table</span><span class=p>:</span><span class=w> </span><span class=o>`</span><span class=n>test</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>aa</span><span class=o>`</span><span class=w>
</span><span class=w>                </span><span class=n>locked_index</span><span class=p>:</span><span class=w> </span><span class=n>GEN_CLUST_INDEX</span><span class=w>
</span><span class=w>                 </span><span class=n>locked_type</span><span class=p>:</span><span class=w> </span><span class=n>RECORD</span><span class=w>
</span><span class=w>              </span><span class=n>waiting_trx_id</span><span class=p>:</span><span class=w> </span><span class=mi>421141623197328</span><span class=w>
</span><span class=w>         </span><span class=n>waiting_trx_started</span><span class=p>:</span><span class=w> </span><span class=mi>2020</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>23</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>40</span><span class=p>:</span><span class=mi>31</span><span class=w>
</span><span class=w>             </span><span class=n>waiting_trx_age</span><span class=p>:</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>50</span><span class=w>
</span><span class=w>     </span><span class=n>waiting_trx_rows_locked</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>   </span><span class=n>waiting_trx_rows_modified</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>                 </span><span class=n>waiting_pid</span><span class=p>:</span><span class=w> </span><span class=mi>13</span><span class=w>
</span><span class=w>               </span><span class=n>waiting_query</span><span class=p>:</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>aa</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>lock</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=k>share</span><span class=w> </span><span class=k>mode</span><span class=w>
</span><span class=w>             </span><span class=n>waiting_lock_id</span><span class=p>:</span><span class=w> </span><span class=mi>421141623197328</span><span class=p>:</span><span class=mi>27</span><span class=p>:</span><span class=mi>3</span><span class=p>:</span><span class=mi>2</span><span class=w>
</span><span class=w>           </span><span class=n>waiting_lock_mode</span><span class=p>:</span><span class=w> </span><span class=n>S</span><span class=w>
</span><span class=w>             </span><span class=n>blocking_trx_id</span><span class=p>:</span><span class=w> </span><span class=mi>108294</span><span class=w>
</span><span class=w>                </span><span class=n>blocking_pid</span><span class=p>:</span><span class=w> </span><span class=mi>12</span><span class=w>
</span><span class=w>              </span><span class=n>blocking_query</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span><span class=w>            </span><span class=n>blocking_lock_id</span><span class=p>:</span><span class=w> </span><span class=mi>108294</span><span class=p>:</span><span class=mi>27</span><span class=p>:</span><span class=mi>3</span><span class=p>:</span><span class=mi>2</span><span class=w>
</span><span class=w>          </span><span class=n>blocking_lock_mode</span><span class=p>:</span><span class=w> </span><span class=n>X</span><span class=w>
</span><span class=w>        </span><span class=n>blocking_trx_started</span><span class=p>:</span><span class=w> </span><span class=mi>2020</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>23</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>38</span><span class=p>:</span><span class=mi>33</span><span class=w>
</span><span class=w>            </span><span class=n>blocking_trx_age</span><span class=p>:</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>02</span><span class=p>:</span><span class=mi>48</span><span class=w>
</span><span class=w>    </span><span class=n>blocking_trx_rows_locked</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=w>
</span><span class=w>  </span><span class=n>blocking_trx_rows_modified</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>     </span><span class=n>sql_kill_blocking_query</span><span class=p>:</span><span class=w> </span><span class=n>KILL</span><span class=w> </span><span class=n>QUERY</span><span class=w> </span><span class=mi>12</span><span class=w>
</span><span class=w></span><span class=n>sql_kill_blocking_connection</span><span class=p>:</span><span class=w> </span><span class=n>KILL</span><span class=w> </span><span class=mi>12</span><span class=w>
</span></code></pre></div><h2 id=日志>日志</h2><h3 id=general_log>general_log</h3><p>general_log 中记录了所有 sql 语句，一般线上不开启。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;general_log&#39;</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 查看日志是否开启
</span><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;log_output&#39;</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 看看日志输出类型: table 或 file
</span><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;general_log_file&#39;</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 看看日志文件保存位置
</span><span class=c1></span><span class=k>set</span><span class=w> </span><span class=k>global</span><span class=w> </span><span class=n>general_log_file</span><span class=o>=</span><span class=s1>&#39;tmp/general.lg&#39;</span><span class=p>;</span><span class=w> </span><span class=c1>-- 设置日志文件保存位置
</span><span class=c1></span><span class=k>set</span><span class=w> </span><span class=k>global</span><span class=w> </span><span class=n>general_log</span><span class=o>=</span><span class=k>on</span><span class=p>;</span><span class=w> </span><span class=c1>-- 开启日志功能
</span><span class=c1></span><span class=k>set</span><span class=w> </span><span class=k>global</span><span class=w> </span><span class=n>log_output</span><span class=o>=</span><span class=s1>&#39;table&#39;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>set</span><span class=w> </span><span class=k>global</span><span class=w> </span><span class=n>log_output</span><span class=o>=</span><span class=s1>&#39;file&#39;</span><span class=p>;</span><span class=w>
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo tail -f /var/lib/mysql/catplanet.log
2020-12-13T09:49:50.048364Z        <span class=m>18</span> Connect   root@localhost on  using Socket
2020-12-13T09:49:50.048760Z        <span class=m>18</span> Query     <span class=k>select</span> @@version_comment limit <span class=m>1</span>
2020-12-13T09:50:04.330063Z        <span class=m>18</span> Query     show databases
2020-12-13T09:50:15.759175Z        <span class=m>18</span> Query     SELECT DATABASE<span class=o>()</span>
2020-12-13T09:50:15.759288Z        <span class=m>18</span> Init DB   <span class=nb>test</span>
2020-12-13T09:50:15.760041Z        <span class=m>18</span> Query     show databases
2020-12-13T09:50:15.760297Z        <span class=m>18</span> Query     show tables
2020-12-13T09:50:15.760403Z        <span class=m>18</span> Field List        aa
2020-12-13T09:50:17.026075Z        <span class=m>18</span> Query     <span class=k>select</span> * from aa
2020-12-13T09:50:24.913874Z        <span class=m>18</span> Query     insert into aa <span class=nb>set</span> <span class=nv>id</span> <span class=o>=</span> <span class=m>12345</span>
</code></pre></div><h3 id=slow_log>slow_log</h3><p>相关设置：</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;%slow%&#39;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>---------------------------+-----------------------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>Variable_name</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>Value</span><span class=w>                             </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>---------------------------+-----------------------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>log_slow_admin_statements</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>OFF</span><span class=w>                               </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>log_slow_slave_statements</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>OFF</span><span class=w>                               </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>slow_launch_time</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=mi>2</span><span class=w>                                 </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>slow_query_log</span><span class=w>            </span><span class=o>|</span><span class=w> </span><span class=k>OFF</span><span class=w>                               </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>slow_query_log_file</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>catplanet</span><span class=o>-</span><span class=n>slow</span><span class=p>.</span><span class=n>log</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>---------------------------+-----------------------------------+
</span></code></pre></div><p>还有 <code>long_query_time</code> 设置了慢查询时间。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;long_query_time&#39;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>-----------------+-----------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>Variable_name</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>Value</span><span class=w>     </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>-----------------+-----------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>long_query_time</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>000000</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>-----------------+-----------+
</span></code></pre></div><p><code>log_queries_not_using_indexes</code> 为 ON 是表示未经过索引的查询也记录到 slow_log 中。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;log_queries_not_using_indexes&#39;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>-------------------------------+-------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>Variable_name</span><span class=w>                 </span><span class=o>|</span><span class=w> </span><span class=n>Value</span><span class=w> </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>-------------------------------+-------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>log_queries_not_using_indexes</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>OFF</span><span class=w>   </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>-------------------------------+-------+
</span></code></pre></div><h3 id=查看-binlog>查看 binlog</h3><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>binlog</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=s1>&#39;mysql-bin.000001&#39;</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>------------------+-----+----------------+-----------+-------------+--------------------------------------------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>Log_name</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Pos</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Event_type</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>Server_id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>End_log_pos</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Info</span><span class=w>                                                   </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>------------------+-----+----------------+-----------+-------------+--------------------------------------------------------+
</span><span class=c1></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000001</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>154</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Anonymous_Gtid</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>219</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>@@</span><span class=k>SESSION</span><span class=p>.</span><span class=n>GTID_NEXT</span><span class=o>=</span><span class=w> </span><span class=s1>&#39;ANONYMOUS&#39;</span><span class=w>                   </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000001</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>219</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Query</span><span class=w>          </span><span class=o>|</span><span class=w>         </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>299</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>BEGIN</span><span class=w>                                                  </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000001</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>299</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Table_map</span><span class=w>      </span><span class=o>|</span><span class=w>         </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>346</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>table_id</span><span class=p>:</span><span class=w> </span><span class=mi>109</span><span class=w> </span><span class=p>(</span><span class=n>test</span><span class=p>.</span><span class=n>t</span><span class=p>)</span><span class=w>                                 </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000001</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>346</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Write_rows</span><span class=w>     </span><span class=o>|</span><span class=w>         </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>394</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>table_id</span><span class=p>:</span><span class=w> </span><span class=mi>109</span><span class=w> </span><span class=n>flags</span><span class=p>:</span><span class=w> </span><span class=n>STMT_END_F</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000001</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>394</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Xid</span><span class=w>            </span><span class=o>|</span><span class=w>         </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>425</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>COMMIT</span><span class=w> </span><span class=cm>/* xid=18 */</span><span class=w>                                    </span><span class=o>|</span><span class=w>
</span><span class=w></span><span class=o>+</span><span class=c1>------------------+-----+----------------+-----------+-------------+--------------------------------------------------------+
</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ sudo mysqlbinlog -vv /var/log/mysql/mysql-bin.000001
BEGIN
/*!*/<span class=p>;</span>
<span class=c1># at 299</span>
<span class=c1>#210102 10:24:02 server id 1  end_log_pos 346 CRC32 0x0e5a4b31  Table_map: `test`.`t` mapped to number 109</span>
<span class=c1># at 346</span>
<span class=c1>#210102 10:24:02 server id 1  end_log_pos 394 CRC32 0x137f70ff  Write_rows: table id 109 flags: STMT_END_F</span>

BINLOG <span class=s1>&#39;
</span><span class=s1>QtnvXxMBAAAALwAAAFoBAAAAAG0AAAAAAAEABHRlc3QAAXQAAwMDEQEAAjFLWg4=
</span><span class=s1>QtnvXx4BAAAAMAAAAIoBAAAAAG0AAAAAAAEAAgAD//gGAAAABgAAAF41oID/cH8T
</span><span class=s1>&#39;</span>/*!*/<span class=p>;</span>
<span class=c1>### INSERT INTO `test`.`t`</span>
<span class=c1>### SET</span>
<span class=c1>###   @1=6 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class=c1>###   @2=6 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class=c1>###   @3=1580572800 /* TIMESTAMP(0) meta=0 nullable=0 is_null=0 */</span>
<span class=c1># at 394</span>
<span class=c1>#210102 10:24:02 server id 1  end_log_pos 425 CRC32 0xd8a728ce  Xid = 18</span>
COMMIT/*!*/<span class=p>;</span>
SET @@SESSION.GTID_NEXT<span class=o>=</span> <span class=s1>&#39;AUTOMATIC&#39;</span> /* added by mysqlbinlog */ /*!*/<span class=p>;</span>
</code></pre></div><h3 id=回滚数据>回滚数据</h3><p>基于 ROW 格式的 binlog， <a href=https://mariadb.com/kb/en/flashback>https://mariadb.com/kb/en/flashback</a> 可以回滚数据。</p><h3 id=监控-binlogredo-log-io-耗时>监控 binlog/redo log IO 耗时</h3><p>统计 redo log IO耗时。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>file_summary_by_event_name</span><span class=w> 
</span><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>event_name</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;wait/io/file/innodb/innodb_log_file&#39;</span><span class=err>\</span><span class=k>G</span><span class=w>
</span><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span><span class=w>               </span><span class=n>EVENT_NAME</span><span class=p>:</span><span class=w> </span><span class=n>wait</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>file</span><span class=o>/</span><span class=n>innodb</span><span class=o>/</span><span class=n>innodb_log_file</span><span class=w>
</span><span class=w>               </span><span class=n>COUNT_STAR</span><span class=p>:</span><span class=w> </span><span class=mi>21</span><span class=w>           </span><span class=c1>-- IO 总次数
</span><span class=c1></span><span class=w>           </span><span class=n>SUM_TIMER_WAIT</span><span class=p>:</span><span class=w> </span><span class=mi>18280881192</span><span class=w>  </span><span class=c1>-- 总计耗时，单位 10^-12 秒
</span><span class=c1></span><span class=w>           </span><span class=n>MIN_TIMER_WAIT</span><span class=p>:</span><span class=w> </span><span class=mi>667968</span><span class=w>
</span><span class=w>           </span><span class=n>AVG_TIMER_WAIT</span><span class=p>:</span><span class=w> </span><span class=mi>870518124</span><span class=w>    </span><span class=c1>-- 平均耗时，例如这个是 870518124 / 1000^3 = 0.87 毫秒
</span><span class=c1></span><span class=w>           </span><span class=n>MAX_TIMER_WAIT</span><span class=p>:</span><span class=w> </span><span class=mi>4605078996</span><span class=w>
</span><span class=w>               </span><span class=n>COUNT_READ</span><span class=p>:</span><span class=w> </span><span class=mi>7</span><span class=w>            </span><span class=c1>-- 读 IO 总次数
</span><span class=c1></span><span class=w>           </span><span class=n>SUM_TIMER_READ</span><span class=p>:</span><span class=w> </span><span class=mi>5538290268</span><span class=w>
</span><span class=w>           </span><span class=n>MIN_TIMER_READ</span><span class=p>:</span><span class=w> </span><span class=mi>667968</span><span class=w>
</span><span class=w>           </span><span class=n>AVG_TIMER_READ</span><span class=p>:</span><span class=w> </span><span class=mi>791184282</span><span class=w>
</span><span class=w>           </span><span class=n>MAX_TIMER_READ</span><span class=p>:</span><span class=w> </span><span class=mi>4605078996</span><span class=w>
</span><span class=w> </span><span class=n>SUM_NUMBER_OF_BYTES_READ</span><span class=p>:</span><span class=w> </span><span class=mi>70144</span><span class=w>
</span><span class=w>              </span><span class=n>COUNT_WRITE</span><span class=p>:</span><span class=w> </span><span class=mi>4</span><span class=w>            </span><span class=c1>-- 写 IO 总次数
</span><span class=c1></span><span class=w>          </span><span class=n>SUM_TIMER_WRITE</span><span class=p>:</span><span class=w> </span><span class=mi>87470880</span><span class=w>
</span><span class=w>          </span><span class=n>MIN_TIMER_WRITE</span><span class=p>:</span><span class=w> </span><span class=mi>11174940</span><span class=w>
</span><span class=w>          </span><span class=n>AVG_TIMER_WRITE</span><span class=p>:</span><span class=w> </span><span class=mi>21867720</span><span class=w>
</span><span class=w>          </span><span class=n>MAX_TIMER_WRITE</span><span class=p>:</span><span class=w> </span><span class=mi>33588324</span><span class=w>
</span><span class=w></span><span class=n>SUM_NUMBER_OF_BYTES_WRITE</span><span class=p>:</span><span class=w> </span><span class=mi>2048</span><span class=w>
</span><span class=w>               </span><span class=n>COUNT_MISC</span><span class=p>:</span><span class=w> </span><span class=mi>10</span><span class=w>            </span><span class=c1>-- fsync 总次数
</span><span class=c1></span><span class=w>           </span><span class=n>SUM_TIMER_MISC</span><span class=p>:</span><span class=w> </span><span class=mi>12655120044</span><span class=w>
</span><span class=w>           </span><span class=n>MIN_TIMER_MISC</span><span class=p>:</span><span class=w> </span><span class=mi>770280</span><span class=w>
</span><span class=w>           </span><span class=n>AVG_TIMER_MISC</span><span class=p>:</span><span class=w> </span><span class=mi>1265511828</span><span class=w>    </span><span class=c1>-- 平均耗时，例如这个是 1265511828 / 1000^3 = 1.27 毫秒
</span><span class=c1></span><span class=w>           </span><span class=n>MAX_TIMER_MISC</span><span class=p>:</span><span class=w> </span><span class=mi>4312570164</span><span class=w>
</span></code></pre></div><p>统计 binlog IO耗时可以使用 <code>file_summary_by_event_name</code> 表中 <code>event_name = "wait/io/file/sql/binlog"</code> 这一行，其各个字段和 redo log 统计字段含义一样。</p><p>使用这个语句监控超过 200 毫秒的 IO。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=n>event_name</span><span class=p>,</span><span class=w> </span><span class=n>MAX_TIMER_WAIT</span><span class=w>
</span><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>performance_schema</span><span class=p>.</span><span class=n>file_summary_by_event_name</span><span class=w>
</span><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>event_name</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>  </span><span class=s1>&#39;wait/io/file/innodb/innodb_log_file&#39;</span><span class=p>,</span><span class=w>
</span><span class=w>  </span><span class=s1>&#39;wait/io/file/sql/binlog&#39;</span><span class=w>
</span><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>MAX_TIMER_WAIT</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>200</span><span class=o>*</span><span class=mi>1000000000</span><span class=p>;</span><span class=w>
</span></code></pre></div><p>每次发现异常后，使用 <code>truncate table performance_schema.file_summary_by_event_name;</code>清空统计，然后继续统计。</p><h3 id=查看主备延迟>查看主备延迟</h3><p>Seconds_Behind_Master 即主备延迟，单位秒。</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>slave</span><span class=w> </span><span class=n>status</span><span class=err>\</span><span class=k>G</span><span class=w>
</span><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span><span class=w>               </span><span class=n>Slave_IO_State</span><span class=p>:</span><span class=w> </span><span class=n>Waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>send</span><span class=w> </span><span class=n>event</span><span class=w>
</span><span class=w>                  </span><span class=n>Master_Host</span><span class=p>:</span><span class=w> </span><span class=mi>172</span><span class=p>.</span><span class=mi>18</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>3</span><span class=w>
</span><span class=w>                  </span><span class=n>Master_User</span><span class=p>:</span><span class=w> </span><span class=n>root</span><span class=w>
</span><span class=w>                  </span><span class=n>Master_Port</span><span class=p>:</span><span class=w> </span><span class=mi>3306</span><span class=w>
</span><span class=w>                </span><span class=n>Connect_Retry</span><span class=p>:</span><span class=w> </span><span class=mi>60</span><span class=w>
</span><span class=w>              </span><span class=n>Master_Log_File</span><span class=p>:</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000003</span><span class=w>
</span><span class=w>          </span><span class=n>Read_Master_Log_Pos</span><span class=p>:</span><span class=w> </span><span class=mi>1270</span><span class=w>
</span><span class=w>               </span><span class=n>Relay_Log_File</span><span class=p>:</span><span class=w> </span><span class=n>aca42f5f012a</span><span class=o>-</span><span class=n>relay</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000004</span><span class=w>
</span><span class=w>                </span><span class=n>Relay_Log_Pos</span><span class=p>:</span><span class=w> </span><span class=mi>1483</span><span class=w>
</span><span class=w>        </span><span class=n>Relay_Master_Log_File</span><span class=p>:</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000003</span><span class=w>
</span><span class=w>             </span><span class=n>Slave_IO_Running</span><span class=p>:</span><span class=w> </span><span class=n>Yes</span><span class=w>
</span><span class=w>            </span><span class=n>Slave_SQL_Running</span><span class=p>:</span><span class=w> </span><span class=n>Yes</span><span class=w>
</span><span class=w>              </span><span class=n>Replicate_Do_DB</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=n>Replicate_Ignore_DB</span><span class=p>:</span><span class=w>
</span><span class=w>           </span><span class=n>Replicate_Do_Table</span><span class=p>:</span><span class=w>
</span><span class=w>       </span><span class=n>Replicate_Ignore_Table</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=n>Replicate_Wild_Do_Table</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=n>Replicate_Wild_Ignore_Table</span><span class=p>:</span><span class=w>
</span><span class=w>                   </span><span class=n>Last_Errno</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>                   </span><span class=n>Last_Error</span><span class=p>:</span><span class=w>
</span><span class=w>                 </span><span class=n>Skip_Counter</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>          </span><span class=n>Exec_Master_Log_Pos</span><span class=p>:</span><span class=w> </span><span class=mi>1270</span><span class=w>
</span><span class=w>              </span><span class=n>Relay_Log_Space</span><span class=p>:</span><span class=w> </span><span class=mi>3076400</span><span class=w>
</span><span class=w>              </span><span class=n>Until_Condition</span><span class=p>:</span><span class=w> </span><span class=k>None</span><span class=w>
</span><span class=w>               </span><span class=n>Until_Log_File</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=n>Until_Log_Pos</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>           </span><span class=n>Master_SSL_Allowed</span><span class=p>:</span><span class=w> </span><span class=k>No</span><span class=w>
</span><span class=w>           </span><span class=n>Master_SSL_CA_File</span><span class=p>:</span><span class=w>
</span><span class=w>           </span><span class=n>Master_SSL_CA_Path</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=n>Master_SSL_Cert</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=n>Master_SSL_Cipher</span><span class=p>:</span><span class=w>
</span><span class=w>               </span><span class=n>Master_SSL_Key</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=n>Seconds_Behind_Master</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w></span><span class=n>Master_SSL_Verify_Server_Cert</span><span class=p>:</span><span class=w> </span><span class=k>No</span><span class=w>
</span><span class=w>                </span><span class=n>Last_IO_Errno</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>                </span><span class=n>Last_IO_Error</span><span class=p>:</span><span class=w>
</span><span class=w>               </span><span class=n>Last_SQL_Errno</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>               </span><span class=n>Last_SQL_Error</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=n>Replicate_Ignore_Server_Ids</span><span class=p>:</span><span class=w>
</span><span class=w>             </span><span class=n>Master_Server_Id</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=w>
</span><span class=w>                  </span><span class=n>Master_UUID</span><span class=p>:</span><span class=w> </span><span class=mi>066</span><span class=n>c671c</span><span class=o>-</span><span class=mi>4</span><span class=n>cce</span><span class=o>-</span><span class=mi>11</span><span class=n>eb</span><span class=o>-</span><span class=mi>9</span><span class=n>b2d</span><span class=o>-</span><span class=mi>0242</span><span class=n>ac110002</span><span class=w>
</span><span class=w>             </span><span class=n>Master_Info_File</span><span class=p>:</span><span class=w> </span><span class=o>/</span><span class=n>var</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>master</span><span class=p>.</span><span class=n>info</span><span class=w>
</span><span class=w>                    </span><span class=n>SQL_Delay</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>          </span><span class=n>SQL_Remaining_Delay</span><span class=p>:</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span><span class=w>      </span><span class=n>Slave_SQL_Running_State</span><span class=p>:</span><span class=w> </span><span class=n>Slave</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=k>read</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=n>relay</span><span class=w> </span><span class=n>log</span><span class=p>;</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>more</span><span class=w> </span><span class=n>updates</span><span class=w>
</span><span class=w>           </span><span class=n>Master_Retry_Count</span><span class=p>:</span><span class=w> </span><span class=mi>86400</span><span class=w>
</span><span class=w>                  </span><span class=n>Master_Bind</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=n>Last_IO_Error_Timestamp</span><span class=p>:</span><span class=w>
</span><span class=w>     </span><span class=n>Last_SQL_Error_Timestamp</span><span class=p>:</span><span class=w>
</span><span class=w>               </span><span class=n>Master_SSL_Crl</span><span class=p>:</span><span class=w>
</span><span class=w>           </span><span class=n>Master_SSL_Crlpath</span><span class=p>:</span><span class=w>
</span><span class=w>           </span><span class=n>Retrieved_Gtid_Set</span><span class=p>:</span><span class=w> </span><span class=mi>066</span><span class=n>c671c</span><span class=o>-</span><span class=mi>4</span><span class=n>cce</span><span class=o>-</span><span class=mi>11</span><span class=n>eb</span><span class=o>-</span><span class=mi>9</span><span class=n>b2d</span><span class=o>-</span><span class=mi>0242</span><span class=n>ac110002</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>10</span><span class=w>
</span><span class=w>            </span><span class=n>Executed_Gtid_Set</span><span class=p>:</span><span class=w> </span><span class=mi>066</span><span class=n>c671c</span><span class=o>-</span><span class=mi>4</span><span class=n>cce</span><span class=o>-</span><span class=mi>11</span><span class=n>eb</span><span class=o>-</span><span class=mi>9</span><span class=n>b2d</span><span class=o>-</span><span class=mi>0242</span><span class=n>ac110002</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span><span class=w>
</span><span class=w></span><span class=mi>09</span><span class=n>a6661b</span><span class=o>-</span><span class=mi>4</span><span class=n>cce</span><span class=o>-</span><span class=mi>11</span><span class=n>eb</span><span class=o>-</span><span class=n>b074</span><span class=o>-</span><span class=mi>0242</span><span class=n>ac110003</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>6</span><span class=w>
</span><span class=w>                </span><span class=n>Auto_Position</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w>         </span><span class=n>Replicate_Rewrite_DB</span><span class=p>:</span><span class=w>
</span><span class=w>                 </span><span class=n>Channel_Name</span><span class=p>:</span><span class=w>
</span></code></pre></div><h3 id=mysqldump>mysqldump</h3><ul><li><code>-d, -–no-data</code>: 表示不导出数据，只导出表结构。</li><li><code>--set-gtid-purged</code>: 表示 binlog 中是否<strong>不记录 GTID</strong>。<code>OFF</code>表示记录gtid，<code>ON</code>表示不记录gtid。如果用 GTID 做了主从，就需要设置这个值为<code>OFF</code>，否则主上恢复数据时从库无法同步。</li><li><code>--single-transaction</code>: 导数据前开启一个事务，保证拿到一致性视图。注意只针对 InnoDB 这种实现了可重复读的引擎。如果 dump 同时有 DDL 可能会报错 <em>Table definition has changed, please retry transaction</em>，因为 mysqldump 拿到表结构但还未 dump 数据前，DDL 如果改表，那么再 dump 数据就会报错。</li></ul><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 导出数据</span>
mysqldump -uroot -p --set-gtid-purged<span class=o>=</span>OFF database table1 table2 &gt; mysqldump.sql
<span class=c1># 只导出数据库表结构</span>
mysqldump -uroot -p --set-gtid-purged<span class=o>=</span>OFF -d database table1 table2 &gt; mysqldump.sql
<span class=c1># 导出所有数据库</span>
mysqldump -uroot -p --set-gtid-purged<span class=o>=</span>OFF --all-databases &gt; mysqldump.sql
<span class=c1># 导出指定几个数据库</span>
mysqldump -uroot -p --set-gtid-purged<span class=o>=</span>OFF --databases db1 db2 &gt; mysqldump.sql
</code></pre></div><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 导入表</span>
mysql -uroot -p database &lt; mysqldump.sql
<span class=c1># 导入数据库</span>
mysql -uroot -p &lt; mysqldump.sql
</code></pre></div><h3 id=sql_safe_updates>sql_safe_updates</h3><p>设置 sql_safe_updates 为 on，预防 delete/update 语句忘记写 where 条件，或者 where 条件中没有包含索引字段。</p><h2 id=innodb-状态>innodb 状态</h2><p><code>show engine innodb status</code> 会列出以下方面信息：</p><ul><li>background thread</li><li>semaphores</li><li>Latest detected Deadlock</li><li>transactions</li><li>file i/o</li><li>insert buffer and adaptive hash index</li><li>log</li><li>buffer pool and memory</li><li>individual buffer pool info</li><li>Row operations</li></ul><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>show</span><span class=w> </span><span class=n>engine</span><span class=w> </span><span class=n>innodb</span><span class=w> </span><span class=n>status</span><span class=err>\</span><span class=k>G</span><span class=w>
</span><span class=w></span><span class=o>***************************</span><span class=w> </span><span class=mi>1</span><span class=p>.</span><span class=w> </span><span class=k>row</span><span class=w> </span><span class=o>***************************</span><span class=w>
</span><span class=w>  </span><span class=k>Type</span><span class=p>:</span><span class=w> </span><span class=n>InnoDB</span><span class=w>
</span><span class=w>  </span><span class=n>Name</span><span class=p>:</span><span class=w> 
</span><span class=w></span><span class=n>Status</span><span class=p>:</span><span class=w> 
</span><span class=w></span><span class=o>=====================================</span><span class=w>
</span><span class=w></span><span class=mi>2021</span><span class=o>-</span><span class=mi>01</span><span class=o>-</span><span class=mi>02</span><span class=w> </span><span class=mi>16</span><span class=p>:</span><span class=mi>54</span><span class=p>:</span><span class=mi>59</span><span class=w> </span><span class=mi>0</span><span class=n>x7f0b24057700</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=n>MONITOR</span><span class=w> </span><span class=k>OUTPUT</span><span class=w>
</span><span class=w></span><span class=o>=====================================</span><span class=w>
</span><span class=w></span><span class=n>Per</span><span class=w> </span><span class=k>second</span><span class=w> </span><span class=n>averages</span><span class=w> </span><span class=n>calculated</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=k>last</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=n>seconds</span><span class=w>
</span><span class=w></span><span class=c1>-----------------
</span><span class=c1></span><span class=n>BACKGROUND</span><span class=w> </span><span class=n>THREAD</span><span class=w>
</span><span class=w></span><span class=c1>-----------------
</span><span class=c1></span><span class=n>srv_master_thread</span><span class=w> </span><span class=n>loops</span><span class=p>:</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>srv_active</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>srv_shutdown</span><span class=p>,</span><span class=w> </span><span class=mi>23541</span><span class=w> </span><span class=n>srv_idle</span><span class=w>
</span><span class=w></span><span class=n>srv_master_thread</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>flush</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>writes</span><span class=p>:</span><span class=w> </span><span class=mi>23546</span><span class=w>
</span><span class=w></span><span class=c1>----------
</span><span class=c1></span><span class=n>SEMAPHORES</span><span class=w>
</span><span class=w></span><span class=c1>----------
</span><span class=c1></span><span class=n>OS</span><span class=w> </span><span class=n>WAIT</span><span class=w> </span><span class=nb>ARRAY</span><span class=w> </span><span class=n>INFO</span><span class=p>:</span><span class=w> </span><span class=n>reservation</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=mi>6</span><span class=w>
</span><span class=w></span><span class=n>OS</span><span class=w> </span><span class=n>WAIT</span><span class=w> </span><span class=nb>ARRAY</span><span class=w> </span><span class=n>INFO</span><span class=p>:</span><span class=w> </span><span class=n>signal</span><span class=w> </span><span class=k>count</span><span class=w> </span><span class=mi>6</span><span class=w>
</span><span class=w></span><span class=n>RW</span><span class=o>-</span><span class=n>shared</span><span class=w> </span><span class=n>spins</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>rounds</span><span class=w> </span><span class=mi>12</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>waits</span><span class=w> </span><span class=mi>6</span><span class=w>
</span><span class=w></span><span class=n>RW</span><span class=o>-</span><span class=n>excl</span><span class=w> </span><span class=n>spins</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>rounds</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>waits</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w></span><span class=n>RW</span><span class=o>-</span><span class=n>sx</span><span class=w> </span><span class=n>spins</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>rounds</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>waits</span><span class=w> </span><span class=mi>0</span><span class=w>
</span><span class=w></span><span class=n>Spin</span><span class=w> </span><span class=n>rounds</span><span class=w> </span><span class=n>per</span><span class=w> </span><span class=n>wait</span><span class=p>:</span><span class=w> </span><span class=mi>12</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>RW</span><span class=o>-</span><span class=n>shared</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>RW</span><span class=o>-</span><span class=n>excl</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>RW</span><span class=o>-</span><span class=n>sx</span><span class=w>
</span><span class=w></span><span class=c1>------------
</span><span class=c1></span><span class=n>TRANSACTIONS</span><span class=w>
</span><span class=w></span><span class=c1>------------
</span><span class=c1></span><span class=n>Trx</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=mi>115978</span><span class=w>
</span><span class=w></span><span class=n>Purge</span><span class=w> </span><span class=n>done</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>trx</span><span class=s1>&#39;s n:o &lt; 0 undo n:o &lt; 0 state: running but idle
</span><span class=s1>History list length 0
</span><span class=s1>LIST OF TRANSACTIONS FOR EACH SESSION:
</span><span class=s1>---TRANSACTION 421161130347256, not started
</span><span class=s1>0 lock struct(s), heap size 1136, 0 row lock(s)
</span><span class=s1>---TRANSACTION 421161130346336, not started
</span><span class=s1>0 lock struct(s), heap size 1136, 0 row lock(s)
</span><span class=s1>---TRANSACTION 115976, ACTIVE 581 sec
</span><span class=s1>2 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
</span><span class=s1>MySQL thread id 22, OS thread handle 139685697177344, query id 91 localhost root
</span><span class=s1>--------
</span><span class=s1>FILE I/O
</span><span class=s1>--------
</span><span class=s1>I/O thread 0 state: waiting for completed aio requests (insert buffer thread)
</span><span class=s1>I/O thread 1 state: waiting for completed aio requests (log thread)
</span><span class=s1>I/O thread 2 state: waiting for completed aio requests (read thread)
</span><span class=s1>I/O thread 3 state: waiting for completed aio requests (read thread)
</span><span class=s1>I/O thread 4 state: waiting for completed aio requests (read thread)
</span><span class=s1>I/O thread 5 state: waiting for completed aio requests (read thread)
</span><span class=s1>I/O thread 6 state: waiting for completed aio requests (write thread)
</span><span class=s1>I/O thread 7 state: waiting for completed aio requests (write thread)
</span><span class=s1>I/O thread 8 state: waiting for completed aio requests (write thread)
</span><span class=s1>I/O thread 9 state: waiting for completed aio requests (write thread)
</span><span class=s1>Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
</span><span class=s1> ibuf aio reads:, log i/o&#39;</span><span class=n>s</span><span class=p>:,</span><span class=w> </span><span class=n>sync</span><span class=w> </span><span class=n>i</span><span class=o>/</span><span class=n>o</span><span class=s1>&#39;s:
</span><span class=s1>Pending flushes (fsync) log: 0; buffer pool: 0
</span><span class=s1>358 OS file reads, 79 OS file writes, 24 OS fsyncs
</span><span class=s1>0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s
</span><span class=s1>-------------------------------------
</span><span class=s1>INSERT BUFFER AND ADAPTIVE HASH INDEX
</span><span class=s1>-------------------------------------
</span><span class=s1>Ibuf: size 1, free list len 0, seg size 2, 0 merges
</span><span class=s1>merged operations:
</span><span class=s1> insert 0, delete mark 0, delete 0
</span><span class=s1>discarded operations:
</span><span class=s1> insert 0, delete mark 0, delete 0
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>Hash table size 34673, node heap has 0 buffer(s)
</span><span class=s1>0.00 hash searches/s, 0.00 non-hash searches/s
</span><span class=s1>---
</span><span class=s1>LOG
</span><span class=s1>---
</span><span class=s1>Log sequence number 19793397
</span><span class=s1>Log flushed up to   19793397
</span><span class=s1>Pages flushed up to 19793397
</span><span class=s1>Last checkpoint at  19793388
</span><span class=s1>0 pending log flushes, 0 pending chkp writes
</span><span class=s1>21 log i/o&#39;</span><span class=n>s</span><span class=w> </span><span class=n>done</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=n>i</span><span class=o>/</span><span class=n>o</span><span class=s1>&#39;s/second
</span><span class=s1>----------------------
</span><span class=s1>BUFFER POOL AND MEMORY
</span><span class=s1>----------------------
</span><span class=s1>Total large memory allocated 137428992
</span><span class=s1>Dictionary memory allocated 143952
</span><span class=s1>Buffer pool size   8191
</span><span class=s1>Free buffers       7830
</span><span class=s1>Database pages     361
</span><span class=s1>Old database pages 0
</span><span class=s1>Modified db pages  0
</span><span class=s1>Pending reads      0
</span><span class=s1>Pending writes: LRU 0, flush list 0, single page 0
</span><span class=s1>Pages made young 0, not young 0
</span><span class=s1>0.00 youngs/s, 0.00 non-youngs/s
</span><span class=s1>Pages read 326, created 35, written 49
</span><span class=s1>0.00 reads/s, 0.00 creates/s, 0.00 writes/s
</span><span class=s1>Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not 0 / 1000         -- 内存命中率
</span><span class=s1>Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
</span><span class=s1>LRU len: 361, unzip_LRU len: 0
</span><span class=s1>I/O sum[0]:cur[0], unzip sum[0]:cur[0]
</span><span class=s1>--------------
</span><span class=s1>ROW OPERATIONS
</span><span class=s1>--------------
</span><span class=s1>0 queries inside InnoDB, 0 queries in queue
</span><span class=s1>0 read views open inside InnoDB
</span><span class=s1>Process ID=9915, Main thread ID=139685853976320, state: sleeping
</span><span class=s1>Number of rows inserted 6, updated 1, deleted 0, read 32
</span><span class=s1>0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.75 reads/s
</span><span class=s1>----------------------------
</span><span class=s1>END OF INNODB MONITOR OUTPUT
</span><span class=s1>============================
</span></code></pre></div><h3 id=buffer-pool-hit-rate>Buffer pool hit rate</h3><p>Buffer pool hit rate 表示 Buffer Pool 命中率。通常一个稳定服务的线上系统，要保证响应时间符合要求的话，内存命中率要在 99% 以上。参数 innodb_buffer_pool_size 确定的，一般建议设置成可用物理内存的 60%~80%。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-01-02</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/blog/tags/mysql/>MySQL</a>,&nbsp;<a href=/blog/tags/troubleshooting/>TroubleShooting</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/blog/>主页</a></span></section></div><div class=post-nav><a href=/blog/posts/database/learning-redis/ class=prev rel=prev title="redis 学习笔记"><i class="fas fa-angle-left fa-fw"></i>redis 学习笔记</a>
<a href=/blog/posts/trouble-shooting/grpc-debug/ class=next rel=next title="如何调试 gRPC">如何调试 gRPC<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.84.4">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=about/ target=_blank>catplanet</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/blog/lib/katex/katex.min.css><link rel=stylesheet href=/blog/lib/katex/copy-tex.min.css><script type=text/javascript src=/blog/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/blog/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/blog/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/blog/lib/katex/katex.min.js></script><script type=text/javascript src=/blog/lib/katex/auto-render.min.js></script><script type=text/javascript src=/blog/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/blog/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:100},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/blog/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-186389448-1')</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-186389448-1" async></script></body></html>